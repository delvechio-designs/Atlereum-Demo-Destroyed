from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse
from django.contrib.auth import get_user_model
from django.views.generic import View

from .models import ChatRoom, Message
from .serializers import MessageSerializer

User = get_user_model()


class ChatListView(View):
    def get(self, request):
        users = User.objects.all().exclude(id=request.user.id)
        context = {"users": users}
        return render(request, "dashboard/chat/home.html", context)


class FetchMessagesView(View):
    def get(self, request, room_name):
        messages = Message.objects.filter(room__name=room_name)
        serializer = MessageSerializer(data=messages, many=True)
        serializer.is_valid()
        data = {"messages": serializer.data}
        return JsonResponse(data, safe=False)
