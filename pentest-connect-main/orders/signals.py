import datetime

from django.db.models.signals import post_save
from django.dispatch import receiver

from .models import Delivery, Order, Revision
from earnings.models import Earning


@receiver(post_save, sender=Delivery)
def update_order_on_delivery_update(sender, instance, created, **kwargs):
    order = instance.order

    if not instance.is_rejected:
        deliveries = order.deliveries.filter(is_rejected=False).order_by("-created_at")
        for delivery in deliveries:
            if delivery.id != instance.id:
                delivery.is_rejected = True
                delivery.save()

    if instance.is_accepted:
        order.is_completed = True
        order.completed_at = datetime.datetime.now()
        order.save()

        earning, created = Earning.objects.get_or_create(order=order, user=order.seller)
        earning.amount = order.price
        earning.save()


@receiver(post_save, sender=Revision)
def update_order_on_revision_update(sender, instance, created, **kwargs):
    order = instance.order

    if created:
        deliveries = order.deliveries.filter(is_rejected=False).order_by("-created_at")
        for delivery in deliveries:
            if delivery.id != instance.id:
                delivery.is_rejected = True
                delivery.save()
