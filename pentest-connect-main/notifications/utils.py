from django.contrib.auth import get_user_model
from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync

User = get_user_model()

def send_notification(user_id, notification_data):
    try:
        # Fetch the User object from the database
        user = User.objects.get(pk=user_id)

        channel_layer = get_channel_layer()
        
        # Construct the unique group name for the user based on their username
        user_group_name = f'notifications_user_{user.username}'
        
        # Send notification to the user's WebSocket group
        async_to_sync(channel_layer.group_send)(
            user_group_name,
            {
                'type': 'notify_client',  # This refers to the 'notify_client' method in the consumer
                'notification': notification_data
            }
        )
    except User.DoesNotExist:
        print(f"User with ID {user_id} does not exist")
